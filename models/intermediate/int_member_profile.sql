SELECT 
    M.MEMBER_ID,
    M.NAME  AS MEMEBER_NAME,
    M.AGE,
    M.GENDER,
    M.CITY,
    M.JOIN_DATE,
    COUNT(DISTINCT T.TXN_ID) AS TOTAL_TRANSACTIONS,
    SUM(T.AMOUNT) AS TOTAL_SPENT,
    COUNT(DISTINCT VISIT_ID) AS TOTAL_VISITS
FROM {{ref("stg_members")}} M
LEFT JOIN {{ref("stg_transactions")}} T
ON M.MEMBER_ID=T.MEMBER_ID
LEFT JOIN {{ref("stg_visits")}} V
ON M.MEMBER_ID=V.MEMBER_ID
GROUP BY M.MEMBER_ID,
    M.NAME,
    M.AGE,
    M.GENDER,
    M.CITY,
    M.JOIN_DATE
